import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { github, vsDark } from "@code-surfer/themes";

export const theme = github;

# Code-First GraphQL server

### @9renpoto



隅田川.js [#3](https://sumidagawajs.connpass.com/event/193786/)

---

# Who am i

- ![https://caddi.rs/assets/logo_eng.svg](https://caddi.rs/assets/logo_eng.svg)
- Likes
  - GraphQL
  - TypeScript
  - React / Preact

---

# Code-First GraphQL server ?

- <img src="https://d33wubrfki0l68.cloudfront.net/e937e774cbbe23635999615ad5d7732decad182a/26072/logo-small.ede75a6b.svg" alt="Nest.js" style="height: 100px" />
- <img src="https://cdn.worldvectorlogo.com/logos/prisma-2.svg" alt="prisma" style="height: 100px" />
- <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQeyl3rnpjZAe7vJH2MZJhuYQ7KMA42skohEw&usqp=CAU" alt="hasura" style="height: 100px" />

今回はデータベースにRDBMSを使うものとする

---

<CodeSurfer>

```typescript title="@nestjs/graphql" subtitle="UserRepository"
import { Field, ID, ObjectType } from '@nestjs/graphql'
import {
  Column,
  Entity,
  EntityRepository,
  PrimaryGeneratedColumn,
} from 'typeorm'
import { BaseRepository } from 'typeorm-transactional-cls-hooked'

@Entity('users')
@ObjectType()
export class User {
  @Field(() => ID)
  @PrimaryGeneratedColumn('uuid')
  readonly id: string

  @Field()
  @Column()
  readonly name: string
}

@EntityRepository(User)
export class UserRepository extends BaseRepository<User> {}
```

```ts title="@nestjs/graphql" subtitle="UserService"
import { Injectable } from '@nestjs/common'
import { In } from 'typeorm'
import { UserRepository } from './user.entity'

@Injectable()
export class UserService {
  constructor(private readonly repo: UserRepository) {}

  async find(ids: readonly string[]) {
    return this.repo.find({
      id: In(ids as string[]),
    })
  }
}
```

```ts title="@nestjs/graphql" subtitle="UserResolver"
import { Args, ID, Query, Resolver } from '@nestjs/graphql'
import DataLoader from 'dataloader'
import { Loader } from 'nestjs-dataloader'
import { User } from './user.entity'
import { UserDataLoader } from './user.loader'

@Resolver('User')
export class UserResolver {
  @Query(() => User)
  async user(
    @Args({ name: 'id', type: () => ID }) id: string,
    @Loader(UserDataLoader.name) loader: DataLoader<string, User>
  ): Promise<User> {
    return loader.load(id)
  }
}
```

```graphql subtitle="@nestjs/graphql"
# ------------------------------------------------------
# THIS FILE WAS AUTOMATICALLY GENERATED (DO NOT MODIFY)
# ------------------------------------------------------

type User {
  id: ID!
  name: String!
  email: String!
}

type Query {
  user(id: ID!): User!
}

```

</CodeSurfer>

---

<CodeSurferColumns themes={[github, vsDark]}>

<Step>

```typescript title="@nestjs/graphql"
import { Field, ID, ObjectType } from '@nestjs/graphql'
import {
  Column,
  Entity,
  EntityRepository,
  PrimaryGeneratedColumn,
} from 'typeorm'
import { BaseRepository } from 'typeorm-transactional-cls-hooked'

@Entity('users')
@ObjectType()
export class User {
  @Field(() => ID)
  @PrimaryGeneratedColumn('uuid')
  readonly id: string

  @Field()
  @Column()
  readonly name: string

  @Field()
  @Column({ unique: true })
  readonly email: string
}

@EntityRepository(User)
export class UserRepository extends BaseRepository<User> {}
```

```js title="prisma 2" subtitle="schema.prisma"
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id    Int     @default(autoincrement()) @id
  name  String?
  email String  @unique
}
```

</Step>

<Step>

```ts
@Entity('users')
@ObjectType()
export class User {
  @Field(() => ID)
  @PrimaryGeneratedColumn('uuid')
  readonly id: string

  @Field()
  @Column()
  readonly name: string

  @Field()
  @Column({ unique: true })
  readonly email: string
}

@EntityRepository(User)
export class UserRepository extends BaseRepository<User> {}

@Injectable()
export class UserService {
  constructor(private readonly repo: UserRepository) {}

  async find(ids: readonly string[]) {
    return this.repo.find({
      id: In(ids as string[]),
    })
  }
}
```

```ts title="prisma 2"
@Resolver(User)
export class UserResolver {
  constructor(@Inject(PrismaService) private prismaService: PrismaService) {}

  @Query((returns) => User, { nullable: true })
  async user(@Args('id') id: number, @Context() ctx) {
    return this.prismaService.user.findOne({
      where: { id: id },
    })
  }
}
```

</Step>

<Step>

```typescript title="@nestjs/graphql"
@Entity('users')
@ObjectType()
export class User {
  @Field(() => ID)
  @PrimaryGeneratedColumn('uuid')
  readonly id: string

  @Field()
  @Column()
  readonly name: string

  @Field()
  @Column({ unique: true })
  readonly email: string
}

@EntityRepository(User)
export class UserRepository extends BaseRepository<User> {}

@Injectable()
export class UserService {
  constructor(private readonly repo: UserRepository) {}

  async find(ids: readonly string[]) {
    return this.repo.find({
      id: In(ids as string[]),
    })
  }
}

@Resolver('User')
export class UserResolver {
  @Query(() => User)
  async user(
    @Args({ name: 'id', type: () => ID }) id: string,
    @Loader(UserDataLoader.name) loader: DataLoader<string, User>
  ): Promise<User> {
    return loader.load(id)
  }
}

```

```ts title="prisma 2" subtitle="nexus-plugin-prisma"
import {
  ApolloServer,
  PubSub
} from 'apollo-server-express'
import express from 'express'
import { nexusPrisma } from 'nexus-plugin-prisma'
import {
  asNexusMethod,
  makeSchema,
  objectType,
  queryType,
  subscriptionType
} from '@nexus/schema'
import { PrismaClient } from '@prisma/client'

const pubsub = new PubSub()
const prisma = new PrismaClient()

const schema = makeSchema({
  typegenAutoConfig: {
    contextType: '{ prisma: PrismaClient.PrismaClient }',
    sources: [{ source: '.prisma/client', alias: 'PrismaClient' }],
  },
  outputs: {
    typegen: path.join(__dirname, 'node_modules/@types/typegen-nexus/index.d.ts'),
    schema: path.join(__dirname, './api.graphql'),
  },
  plugins: [
    nexusPrisma({
      experimentalCRUD: true,
    }),
  ],
  types: [
    queryType({
      definition(t) {
        t.crud.user()
        t.crud.users({ ordering: true })
      },
    }),
    objectType({
      name: 'User',
      definition(t) {
        t.model.id()
        t.model.name()
        t.model.email()
      },
    }),
  ],
})
```

</Step>

</CodeSurferColumns>
